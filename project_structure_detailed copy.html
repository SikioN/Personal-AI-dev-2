<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal-AI: Архитектура и Процессы (V4)</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a365d',
                        secondary: '#2b6cb0',
                        accent: '#c53030',
                        success: '#2f855a',
                        light: '#ebf8ff',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
        }

        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            margin-bottom: 2rem;
        }

        .section-header {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            color: #1a365d;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .method-ref {
            font-family: 'Fira Code', monospace;
            color: #c53030;
            background: #fff5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .file-path {
            color: #718096;
            font-size: 0.75rem;
            font-family: monospace;
            display: block;
            margin-top: 0.25rem;
        }
    </style>
</head>

<body class="text-slate-800">

    <header class="bg-primary text-white p-6 shadow-lg fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Personal-AI <span class="opacity-75 text-sm font-normal">| Full System
                    Documentation</span></h1>
            <nav class="space-x-6 text-sm">
                <a href="#grand-diagram" class="hover:text-light transition">Глобальная Схема</a>
                <a href="#lifecycle" class="hover:text-light transition">Жизненный Цикл</a>
                <a href="#inputs" class="hover:text-light transition">Входы и Форматы</a>
                <a href="#setup" class="hover:text-light transition">Сборка и Запуск</a>
            </nav>
        </div>
    </header>

    <main class="pt-28 max-w-7xl mx-auto p-8 space-y-16">

        <!-- GRAND DIAGRAM -->
        <section id="grand-diagram">
            <h2 class="section-header">01. Глобальная Схема Проекта (End-to-End)</h2>
            <p class="mb-4 text-gray-600">Диаграмма охватывает полный цикл: от инициализации и обучения до обработки
                запросов пользователя. Цветом выделены разные подсистемы.</p>

            <div class="mermaid">
                graph TB

                %% Subsystems
                subgraph Init [Инициализация и Настройка]
                direction TB
                Config[Config Objects] -->|Params| PAI[PersonalAI Class]
                Docker[Docker Containers] -.->|Host/Port| Drivers[DB Drivers]
                Drivers -->|Connect| PAI
                end

                subgraph Input [Входные Данные]
                RawText[Текст / Документы]
                UserQuery[Вопрос пользователя]
                end

                subgraph Memorize [Обучение (MemorizePipeline)]
                direction TB
                Ext[LLMExtractor] -->|JSON to Triplets| Upd[LLMUpdator]
                Upd -->|Search Conflicts| KGRead[Read Graph]
                KGRead -->|Check| LLM_Conflict["LLM: Is Obsolete?"]
                LLM_Conflict -- Yes --> Del[Delete Obsolete]
                LLM_Conflict -- No --> Add[Add New]
                end

                subgraph QA [Инференс (QAPipeline)]
                direction TB
                Prep[QueryPreprocessor] --> Reason[WeakKGReasoner]
                Reason -->|1. Vector Search| ChromaRetrieval
                Reason -->|2. Graph Search| Neo4jRetrieval
                Neo4jRetrieval -->|Context Subgraph| Gen[AnswerGenerator]
                Gen -->|LLM Synthesis| FinalAns[Финальный Ответ]
                end

                subgraph Storage [Шина Данных]
                Neo4j[(Neo4j: Graph DB)]
                Chroma[(ChromaDB: Vectors)]
                LLM_API((LLM API))
                end

                %% Flows
                PAI -->|init| Memorize
                PAI -->|init| QA

                %% Learn Flow
                RawText -->|update_memory()| Memorize
                Memorize <-->|Extract/Verify| LLM_API
                    Del & Add --> Neo4j & Chroma

                    %% QA Flow
                    UserQuery -->|answer_question()| QA
                    QA <-->|Embed/Gen| LLM_API
                        ChromaRetrieval <--> Chroma
                            Neo4jRetrieval <--> Neo4j
                                FinalAns --> User[Пользователь]

                                %% Styling
                                style Init fill:#e6fffa,stroke:#38b2ac,stroke-width:2px
                                style Memorize fill:#fff5f5,stroke:#fc8181,stroke-width:2px
                                style QA fill:#ebf8ff,stroke:#63b3ed,stroke-width:2px
                                style Storage fill:#f7fafc,stroke:#a0aec0,stroke-width:2px,stroke-dasharray: 5 5
            </div>
        </section>


        <!-- PROJECT LIFECYCLE -->
        <section id="lifecycle">
            <h2 class="section-header">02. Подробный Жизненный Цикл Проекта Step-by-Step</h2>

            <div class="space-y-8">
                <!-- PHASE 1 -->
                <div class="bg-white p-6 rounded-lg shadow border border-indigo-100">
                    <h3 class="text-xl font-bold text-indigo-700 mb-4">Фаза 1: Инициализация (Bootstrap)</h3>
                    <div class="space-y-4">
                        <div class="pl-4 border-l-4 border-indigo-300">
                            <h4 class="font-bold">1. Загрузка Конфигураций</h4>
                            <span class="method-ref">src/personalai_main.py :: PersonalAIConfig</span>
                            <p class="text-sm mt-1">Создаются объекты конфигурации для каждого компонента
                                (`MemPipelineConfig`, `QAPipelineConfig`). Здесь задаются пути к логам, настройки LLM
                                (temp, model) и параметры подключения к БД.</p>
                        </div>
                        <div class="pl-4 border-l-4 border-indigo-300">
                            <h4 class="font-bold">2. Подключение Драйверов</h4>
                            <span class="method-ref">src/db_drivers/graph_driver/GraphDriver.py :: connect</span>
                            <p class="text-sm mt-1">Физическое соединение с Neo4j (порт 7687) и ChromaDB. Если базы
                                недоступны, процесс упадет с ошибкой соединения.</p>
                        </div>
                    </div>
                </div>

                <!-- PHASE 2 -->
                <div class="bg-white p-6 rounded-lg shadow border border-red-100">
                    <h3 class="text-xl font-bold text-red-700 mb-4">Фаза 2: Обучение (Memorize Process)</h3>
                    <p class="text-sm text-gray-500 mb-4">Вход: Неструктурированный текст.</p>

                    <div class="space-y-4">
                        <div class="pl-4 border-l-4 border-red-300">
                            <h4 class="font-bold">Шаг 1: Экстракция (Extraction)</h4>
                            <span class="method-ref">src/pipelines/memorize/extractor/LLMExtractor.py ::
                                extract_knowledge</span>
                            <p class="text-sm mt-1">Текст отправляется в LLM с промптом "Выдели сущности и связи". LLM
                                возвращает JSON. JSON валидируется и превращается в объекты <code
                                    class="bg-gray-100 px-1">Triplet</code>.</p>
                        </div>
                        <div class="pl-4 border-l-4 border-red-300">
                            <h4 class="font-bold">Шаг 2: Поиск Противоречий (Conflict Resolution)</h4>
                            <span class="method-ref">src/pipelines/memorize/updator/LLMUpdator.py ::
                                find_obsolete_...</span>
                            <p class="text-sm mt-1">Самый сложный этап. Для каждого нового факта система ищет в графе
                                "соседей".
                                <br><i>Пример:</i> Пришел факт "Адам живет в США". В графе есть "Адам живет в РФ".
                                <br>LLM спрашивают: "Эти факты противоречат?". Если да -> старый помечается на удаление.
                            </p>
                        </div>
                        <div class="pl-4 border-l-4 border-red-300">
                            <h4 class="font-bold">Шаг 3: Физическая Запись (Persist)</h4>
                            <span class="method-ref">src/kg_model/graph_model.py :: create_triplets</span>
                            <p class="text-sm mt-1">
                                1. Удаление старых триплетов (Cypher DELETE).<br>
                                2. Создание новых вершин и связей (Cypher CREATE).<br>
                                3. Генерация эмбеддингов для новых узлов и запись в ChromaDB.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- PHASE 3 -->
                <div class="bg-white p-6 rounded-lg shadow border border-blue-100">
                    <h3 class="text-xl font-bold text-blue-700 mb-4">Фаза 3: Инференс (QA Process)</h3>
                    <p class="text-sm text-gray-500 mb-4">Вход: Вопрос пользователя.</p>

                    <div class="space-y-4">
                        <div class="pl-4 border-l-4 border-blue-300">
                            <h4 class="font-bold">Шаг 1: Парсинг и Векторный Поиск</h4>
                            <span
                                class="method-ref">src/pipelines/qa/kg_reasoning/weak_reasoner/WeakKGReasoner.py</span>
                            <p class="text-sm mt-1">Из вопроса выделяются ключевые слова ("Где Адам?"). Они
                                векторизуются и ищутся в ChromaDB (Top-K Nodes).</p>
                        </div>
                        <div class="pl-4 border-l-4 border-blue-300">
                            <h4 class="font-bold">Шаг 2: Сбор Контекста (Graph Traversal)</h4>
                            <span class="method-ref">src/db_drivers/graph_driver/connectors/Neo4jConnector.py ::
                                get_triplets</span>
                            <p class="text-sm mt-1">Для найденных узлов выгружается их окружение из Neo4j (соседи на 1-2
                                хопа). Это формирует "локальный граф контекста".</p>
                        </div>
                        <div class="pl-4 border-l-4 border-blue-300">
                            <h4 class="font-bold">Шаг 3: Генерация RAG</h4>
                            <span class="method-ref">src/pipelines/qa/answers_aggregation/AnswersAggregator.py</span>
                            <p class="text-sm mt-1">Контекст (списком фактов) + Вопрос подаются в LLM. Модель генерирует
                                ответ на естественном языке.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- INPUTS AND FORMATS -->
        <section id="inputs">
            <h2 class="section-header">03. Форматы, Входы и Размерности</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-800 text-slate-100 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-yellow-500 mb-2">Входной Вектор (Embeddings)</h3>
                    <ul class="space-y-2 text-sm font-mono">
                        <li><strong>Модель:</strong> intfloat/multilingual-e5-small</li>
                        <li><strong>Размерность:</strong> 384 float32</li>
                        <li><strong>Нормализация:</strong> L2 Norm (True)</li>
                        <li><strong>Применение:</strong> Поиск узлов по смыслу</li>
                    </ul>
                </div>

                <div class="bg-slate-800 text-slate-100 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-green-500 mb-2">База Данных (Graph Schema)</h3>
                    <ul class="space-y-2 text-sm font-mono">
                        <li><strong>Node Labels:</strong> [object, hyper, episodic, time]</li>
                        <li><strong>Rel Types:</strong> [simple, hyper, episodic, time]</li>
                        <li><strong>ID Format:</strong> MD5 Hash string (e.g., "5d4140...")</li>
                    </ul>
                </div>
            </div>
        </section>


        <!-- SETUP AND LAUNCH -->
        <section id="setup">
            <h2 class="section-header">04. Сборка и Запуск Проекта</h2>

            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold mb-4">Предварительные требования:</h3>
                <ul class="list-disc list-inside mb-4 text-sm text-gray-700">
                    <li>Docker & Docker Compose (для поднятия инфраструктуры)</li>
                    <li>Python 3.9+</li>
                    <li>Доступ к API LLM (OpenAI / GigaChat)</li>
                </ul>

                <h3 class="font-bold mb-4">Инструкция по запуску:</h3>
                <div class="bg-gray-100 p-4 rounded text-sm font-mono whitespace-pre overflow-x-auto border">
                    # 1. Поднятие инфраструктуры (БД)
                    docker run -d -p 7687:7687 -p 7474:7474 --name neo4j neo4j:latest

                    # 2. Установка зависимостей
                    pip install -r requirements.txt

                    # 3. Настройка переменных окружения (.env)
                    export OPENAI_API_KEY="sk-..."
                    export NEO4J_PASSWORD="password"

                    # 4. Запуск тестов (Проверка сборки)
                    pytest tests/

                    # 5. Запуск основного цикла (пример скрипта)
                    python experiments/main_experiment.py
                </div>
            </div>
        </section>

        <!-- DETAILED FUNCTION REGISTRY (NEW) -->
        <section id="deep-registry">
            <h2 class="section-header">05. Детальный Реестр Функций и Трансформаций</h2>
            <p class="mb-4 text-gray-600">В этом разделе описан каждый программный компонент в деталях: входные
                параметры, формат выходных данных и внутренняя логика.</p>

            <div class="space-y-8">

                <!-- COMPONENT: AGENT DRIVER -->
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500">
                    <h3 class="text-lg font-bold text-purple-700 mb-2">1. AgentDriver (Драйвер Агентов)</h3>
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded border">
                            <span class="method-ref">src/agents/AgentDriver.py :: generate</span>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 text-sm">
                                <div>
                                    <strong class="block text-gray-700">Вход (Inputs):</strong>
                                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                                        <li>`system_prompt` (str): Роль агента ("Ты помощник...").</li>
                                        <li>`user_prompt` (str): Задача ("Найди ошибки в...").</li>
                                        <li>`assistant_prompt` (str): Примеры или начало ответа.</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong class="block text-gray-700">Выход (Outputs):</strong>
                                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                                        <li>`answer` (str): Сырой текст ответа от LLM.</li>
                                    </ul>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 italic">Логика: Формирует HTTP-запрос к провайдеру
                                (OpenAI/GigaChat), управляет ретраями и таймаутами.</p>
                        </div>
                    </div>
                </div>

                <!-- COMPONENT: KNOWLEDGE RETRIEVER -->
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                    <h3 class="text-lg font-bold text-blue-700 mb-2">2. KnowledgeRetriever (Поисковик Знаний)</h3>
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded border">
                            <span
                                class="method-ref">src/pipelines/qa/kg_reasoning/knowledge_retriever/KnowledgeRetriever.py
                                :: retrieve</span>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 text-sm">
                                <div>
                                    <strong class="block text-gray-700">Вход (Inputs):</strong>
                                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                                        <li>`query_info` (QueryInfo): Объект с entities=["Том"].</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong class="block text-gray-700">Выход (Outputs):</strong>
                                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                                        <li>`triplets` (List[Triplet]): Список фактов (подграф).</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-3 text-xs bg-slate-800 text-slate-200 p-2 rounded font-mono">
                                # Логика работы:
                                1. Берет entity (например "Том").
                                2. Находит ID узла через self.kg_model.find_node_id("Том").
                                3. Выполняет Cypher:
                                MATCH (n)-[r]-(m) WHERE id(n)=... RETURN r, m
                                4. Конвертирует результат Neo4j Driver (Record) -> Triplet Objects.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- COMPONENT: DATA STRUCTURES INTERNAL -->
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                    <h3 class="text-lg font-bold text-green-700 mb-2">3. Data Structs Internal (Внутренние Структуры)
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">Детальное описание полей, используемых для хеширования и ID.
                    </p>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs text-left">
                            <thead class="bg-gray-100 font-bold">
                                <tr>
                                    <th class="p-2">Класс</th>
                                    <th class="p-2">Поле ID (hash)</th>
                                    <th class="p-2">Алгоритм Хеширования</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <tr>
                                    <td class="p-2 font-mono">Node</td>
                                    <td class="p-2">self.id</td>
                                    <td class="p-2">md5(self.name + self.type)</td>
                                </tr>
                                <tr>
                                    <td class="p-2 font-mono">Relation</td>
                                    <td class="p-2">self.id</td>
                                    <td class="p-2">md5(self.name + self.type)</td>
                                </tr>
                                <tr>
                                    <td class="p-2 font-mono">Triplet</td>
                                    <td class="p-2">self.id</td>
                                    <td class="p-2">md5(start.id + rel.id + end.id)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </section>

    </main>

    <footer class="bg-primary text-white p-10 text-center mt-12">
        <p class="opacity-75">Personal-AI Technical Reference Manual V4.0 | Generated via Agentic Analysis</p>
    </footer>

    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>

</html>